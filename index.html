<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="技术的终极目标是简洁">
<meta property="og:type" content="website">
<meta property="og:title" content="Simple">
<meta property="og:url" content="cedar-renjun.github.io/index.html">
<meta property="og:site_name" content="Simple">
<meta property="og:description" content="技术的终极目标是简洁">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simple">
<meta name="twitter:description" content="技术的终极目标是简洁">
  
    <link rel="alternative" href="/atom.xml" title="Simple" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Do one thing and do it well</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/cedar-renjun" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/1995742315/profile?topnav=1&wvr=6" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/BLE4-0/" style="font-size: 10px;">BLE4.0</a> <a href="/tags/CC26xx/" style="font-size: 10px;">CC26xx</a> <a href="/tags/Debugger/" style="font-size: 12.5px;">Debugger</a> <a href="/tags/ELF/" style="font-size: 15px;">ELF</a> <a href="/tags/GPIO/" style="font-size: 10px;">GPIO</a> <a href="/tags/Hacker/" style="font-size: 12.5px;">Hacker</a> <a href="/tags/IAR/" style="font-size: 10px;">IAR</a> <a href="/tags/IDA/" style="font-size: 12.5px;">IDA</a> <a href="/tags/Jlink/" style="font-size: 10px;">Jlink</a> <a href="/tags/M1/" style="font-size: 10px;">M1</a> <a href="/tags/NFC/" style="font-size: 12.5px;">NFC</a> <a href="/tags/Nucleo/" style="font-size: 10px;">Nucleo</a> <a href="/tags/PN532/" style="font-size: 10px;">PN532</a> <a href="/tags/QT/" style="font-size: 10px;">QT</a> <a href="/tags/RFID/" style="font-size: 10px;">RFID</a> <a href="/tags/STM32/" style="font-size: 10px;">STM32</a> <a href="/tags/STM32F4/" style="font-size: 10px;">STM32F4</a> <a href="/tags/STM32F7/" style="font-size: 10px;">STM32F7</a> <a href="/tags/TI/" style="font-size: 10px;">TI</a> <a href="/tags/USB/" style="font-size: 20px;">USB</a> <a href="/tags/elua/" style="font-size: 10px;">elua</a> <a href="/tags/lua/" style="font-size: 10px;">lua</a> <a href="/tags/sublime-text/" style="font-size: 10px;">sublime text</a> <a href="/tags/微信订阅号/" style="font-size: 17.5px;">微信订阅号</a> <a href="/tags/树莓派/" style="font-size: 12.5px;">树莓派</a> <a href="/tags/示波器/" style="font-size: 10px;">示波器</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.miaoxiong.net/">喵兄</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://ahnniu.github.io/">牛工</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">Cedar, 嵌入式软件工程师，玩过各种MCU，熟悉无线协议栈，USB，RTOS，半个软件架构师，最近在折腾调试器. QQ: 819280802</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Do one thing and do it well</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="null" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Do one thing and do it well</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/cedar-renjun" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/1995742315/profile?topnav=1&wvr=6" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-nucleo-stm32F410rb" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/25/nucleo-stm32F410rb/" class="article-date">
  	<time datetime="2015-12-25T14:40:23.000Z" itemprop="datePublished">2015-12-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/25/nucleo-stm32F410rb/">STM32 F410RB Nucleo</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="STM32F410RB_Nucleo测评">STM32F410RB Nucleo测评</h3><h4 id="1_综述">1    综述</h4><p>最近拿到一块STM32F410的Nucleo板子，给大家介绍一下ST新出的F410系列</p>
<p><img src="http://www.st.com/st-web-ui/static/active/en/fragment/product_related/rpn_information/board_photo/nucleo-F4.jpg" alt="ST32F410"></p>
<h4 id="2_STM32F410芯片">2    STM32F410芯片</h4><p>F410是ST新推出的一款M4内核MCU，主频100MHz，主打低功耗，动态功耗竟然达到了89uA/MHz，Stop模式待机电流6uA。堪称里程碑！</p>
<p>什么概念呢？<br>在保持同等运算性能的情况下，功耗是F405的1/10，直逼L4系列，要知道L4是ST的低功耗，高性能产品线代表作品</p>
<p>F410的出现给大家多了一个M4选择：功能强劲，价格足够低，低功耗能力非常突出</p>
<p>我的新产品，准备用这颗F410来做</p>
<h5 id="2-_1_主打特性">2.    1    主打特性</h5><ol>
<li>Dynamic Efficiency Line with BAM (Batch Acquisition Mode)<br>Core: ARM®32-bit Cortex®-M4 CPU with FPU, Adaptive real-time accelerator (ART Accelerator™) allowing 0-wait state execution from Flash memory, frequency up to 100 MHz, memory protection unit, 125 DMIPS/1.25 DMIPS/MHz (Dhrystone 2.1), and DSP instructions<br>Memories</li>
<li>Up to 128 Kbytes of Flash memory</li>
<li>512 bytes of OTP memory</li>
<li>32 Kbytes of SRAM</li>
<li>Clock, reset and supply management</li>
<li>1.7 V to 3.6 V application supply and I/Os</li>
<li>POR, PDR, PVD and BOR</li>
<li>4-to-26 MHz crystal oscillator</li>
<li>Power consumption<br>Run: 89 μA/MHz (peripheral off)<br>Stop (Flash in Stop mode, fast wakeup time): 40 μA Typ @ 25 °C; 49 μA max @25 °C<br>Stop (Flash in Deep power down mode, fast wakeup time): down to 6 μA @ 25 °C; 14 μA max @25 °C<br>Standby: 2.4 μA @25 °C / 1.7 V without RTC; 12 μA @85 °C @1.7 V<br>VBATsupply for RTC: 1 μA @25 °C</li>
<li>1×12-bit, 2.4 MSPS ADC: up to 16 channels</li>
<li>1×12-bit D/A converter</li>
<li>General-purpose DMA: 16-stream DMA controllers with FIFOs and burst support</li>
<li>Up to 9 timers</li>
<li>One 16-bit advanced motor-control timer</li>
<li>One low-power timer (available in Stop mode)</li>
<li>Three 16-bit general purpose timers</li>
<li>One 32-bit timer up to 100 MHz with up to four IC/OC/PWM or pulse counter and quadrature (incremental) encoder input</li>
</ol>
<h5 id="2-2_功耗">2.2    功耗</h5><blockquote>
<p>Power consumption</p>
<ol>
<li>Run: 89 μA/MHz (peripheral off)</li>
<li>Stop (Flash in Stop mode, fast wakeup time): 40 μA Typ @ 25 °C; 49 μA max @25 °C</li>
<li>Stop (Flash in Deep power down mode, fast wakeup time): down to 6 μA @ 25 °C; 14 μA max @25 °C</li>
<li>Standby: 2.4 μA @25 °C / 1.7 V without RTC; 12 μA @85 °C @1.7 V</li>
<li>VBATsupply for RTC: 1 μA @25 °C</li>
</ol>
</blockquote>
<h5 id="2-3_价格优势">2.3    价格优势</h5><p>F410在保持M4高性能，DMA低功耗的特征下，裁剪了FLASH，RAM和一部分外设，价格是F405的1/3，2个美金左右，性价比非常非常高</p>
<h4 id="3_用户群">3    用户群</h4><ol>
<li>学生<br>可以通过ST Nucleo 开发板和ST提供的软件来学习STM32系列MCU</li>
<li>系统工程师<br>在需要使用高性能和低功耗的场景下，同时应用不需要太高的FLASH，RAM，F410系列是你不二的选择：性能强劲，功耗表现优异，性价比非常高</li>
</ol>
<h4 id="4_Nucleo系列开发板">4    Nucleo系列开发板</h4><p>ST 推出Nucleo系列，就是为了让各位以最低的成本，快速熟悉STM32 MCU；使用Nucleo兼容库，快速创建自己的产品原型</p>
<p>在设计之初，Nucleo就考虑到了兼容性，所以可以兼容F1/2/3/4系列MCU，对外接口兼容Arduino，同时还有ST自己的专用拓展接口，从而达到最大程度的兼容性，拓展性</p>
<h5 id="4-1_硬件">4.1    硬件</h5><ol>
<li>64Pin的LQFP封装</li>
<li>自带SWD调试接口</li>
<li>自带ST-Link/V2-1</li>
<li>USB供电和通讯</li>
</ol>
<p>F410的原理图，点击这个链接<a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/data_brief/DM00105918.pdf" target="_blank" rel="external">http://www.st.com/st-web-ui/static/active/en/resource/technical/document/data_brief/DM00105918.pdf</a></p>
<p>可以查看具体MCU的管脚分配情况和具体用法</p>
<h5 id="4-2_软件">4.2    软件</h5><p>软件方面，Nucleo使用HAL层来兼容所有的Nucleo板，也提供了非常丰富的软件用例，无缝切换</p>
<p>编译器方面，Nucleo支持IAR,Keil,GCC, Mbed等各种编译器开发环境，无所不包</p>
<h4 id="5_开发板购买链接">5    开发板购买链接</h4><p>STM32推出的Nucleo STM32F410开发板价格相当实惠，10个美金左右，折合人民币（含税）也就是80块钱左右</p>
<p>各位可以去mouser上下单订购，很方便，链接如下<br><a href="http://www.mouser.cn/ProductDetail/STMicroelectronics/NUCLEO-F410RB/?qs=%2fha2pyFaduj0LE%252bzmDN2WGsLI%2fSHDmqnrJvkB00UMkqt9XNS%252b5tWLg%3d%3d" target="_blank" rel="external">http://www.mouser.cn/ProductDetail/STMicroelectronics/NUCLEO-F410RB/?qs=%2fha2pyFaduj0LE%252bzmDN2WGsLI%2fSHDmqnrJvkB00UMkqt9XNS%252b5tWLg%3d%3d</a></p>
<h4 id="6_参考资料">6    参考资料</h4><ol>
<li><a href="http://www.st.com/web/en/catalog/mmc/FM141/SC1169" target="_blank" rel="external">ST Cortex-M MCU</a></li>
<li><a href="http://www.st.com/web/en/catalog/mmc/FM141/SC1169/SS1577" target="_blank" rel="external">STM32F4 系列</a></li>
<li><a href="http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/LN1847?sc=stm32nucleo" target="_blank" rel="external">ST Nucleo开发板</a></li>
<li><a href="www.mbed.org">Mbed</a></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nucleo/">Nucleo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32F4/">STM32F4</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-USB-reference-documents" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/20/USB-reference-documents/" class="article-date">
  	<time datetime="2015-12-20T14:51:02.000Z" itemprop="datePublished">2015-12-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/20/USB-reference-documents/">USB 参考资料</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>涉及到USB 基本知识，HID，MSD和应用笔记，希望对各位有帮助</p>
<p>点击下载<br><a href="http://cedar-renjun.github.io/asserts/2015/12/20/USB资料.zip">http://cedar-renjun.github.io/asserts/2015/12/20/USB资料.zip</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-9-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/18/Day-9-USB/" class="article-date">
  	<time datetime="2015-12-18T11:55:15.000Z" itemprop="datePublished">2015-12-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/18/Day-9-USB/">Day9 USB设备速度识别</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1_识别原理">1 识别原理</h4><p>默认情况下，USB主机端口的DP，DM都有一个15K的下拉电阻，在设备没有插入时，DP／DM信号电平为低；当有设备插入时，因为设备端DP／DM中有上拉电阻，所以会<br>把DP或者DM拉高；</p>
<p>USB主机通过DP，DM线的高电平变化情况，可以识别到设备插入和拔出，识别不同USB Device的速度</p>
<p>对于USB2.0来说，有三个等级的设备速度：低速／全速／高速</p>
<ol>
<li><p>低速识别<br>在设备DM端接一个1.5K的上拉电阻，如下图所示<br><img src="http://cedar-renjun.github.io/images/2015/12/18/0.png" alt="USB 低速设备"></p>
</li>
<li><p>全速识别<br>在设备DP端接一个1.5K的上拉电阻，如下图所示<br><img src="http://cedar-renjun.github.io/images/2015/12/18/1.png" alt="USB 全速设备"></p>
</li>
<li><p>高速识别<br>在设备DP端接一个1.5K的上拉电阻，和全速设备一样；但复位后，USB设备会通过一系列的软硬件握手协议来和HUB协商速度<br>具体过程，如下所示</p>
</li>
</ol>
<blockquote>
<p><strong>High-speed Detection Handshake (not performed if low-speed device detected by hub):</strong><br>Note: In the following handshake, both the hub and device are required to detect Chirp J’s and K’s of specified minimum durations. It is strongly recommended that “gaps” in these Chirp signals as short as 16 high-speed bit times should restart the duration timers.</p>
<ol>
<li>The high-speed device leaves the D+ pull-up resistor connected, leaves the high-speed terminations disabled, and drives the high-speed signaling current into the D- line. This creates a Chirp K on the bus. The device chirp must last no less than 1.0 ms (TUCH) and must end no more than 7.0 ms (TUCHEND) after high-speed Reset time T0.</li>
<li>The hub must detect the device chirp after it has seen assertion of the Chirp K for no less than 2.5 μs (TFILT). If the hub does not detect a device chirp, it must continue the assertion of SE0 until the end of reset.</li>
<li>No more than 100 μs (TWTDCH) after the bus leaves the Chirp K state, the hub must begin to send an alternating sequence of Chirp K’s and Chirp J’s. There must be no Idle states on the bus between the J’s and K’s. This sequence must continue until a time (TDCHSE0) no more than 500 μs before and no less than 100 μs before the end of Reset. (This will guarantee that the bus remains active, preventing the device from entering the high-speed Suspend state.) Each individual Chirp K and Chirp J must last no less than 40 μs and no more than 60 μs (TDCHBIT).</li>
<li>After completing the hub chirp sequence, the hub asserts SE0 until end of Reset. At the end of reset, the hub must transition to the high-speed Enabled state without causing any transitions on the data lines.</li>
<li>After the device completes its chirp, it looks for the high-speed hub chirp. At a minimum, the device is required to see the sequence Chirp K-J-K-J-K-J in order to detect a valid hub chirp. Each individual Chirp K and Chirp J must be detected for no less than 2.5 μs (TFILT).<br>a) If the device detects the sequence Chirp K-J-K-J-K-J, then no more than 500 μs (TWTHS) after detection, the device is required to disconnect the D+ pull-up resistor, enable the high-speed terminations, and enter the high-speed Default state.<br>b) If the device has not detected the sequence Chirp K-J-K-J-K-J by a time no less than 1.0 ms and no more than 2.5 ms (TWTFS) after completing its own chirp, then the device is required to revert to the full-speed Default state and wait for the end of Reset.</li>
</ol>
</blockquote>
<h4 id="2_注意事项">2 注意事项</h4><ol>
<li>对于STM32F105/107/F2/F4来说，内部已经集成上拉／下拉，并根据对应的设备角色和行为，USB内核会自动切换合适电阻；所以外部无需接额外的电阻；<br>但是对STM32F103系列来说，必须要外接合适的上拉电阻</li>
<li><strong>上拉电平的范围是3.0~3.6V</strong></li>
<li>电阻的精度可以为5%</li>
</ol>
<h3 id="每日推荐">每日推荐</h3><ol>
<li>暗时间–刘未鹏.pdf</li>
</ol>
<p>一本关于心智模式、学习方法和时间利用的书籍，就像暗物质一样，看不见，摸不着，但充满了整个宇宙；时间也是类似，很多零碎的时间，如何有效利用起来，是一个很大的学问；</p>
<p>关于作者:刘未鹏</p>
<blockquote>
<p>南京大学计算机系硕士毕业<br>现就职于微软亚洲研究院创新工程中心<br>兴趣爱好：计算机科学，人工智能，认知科学<br>博客名 Mind Hacks 的含义：</p>
<ul>
<li>Mind Hacks 是一本书</li>
<li>Mind Hacks 是一系列思维工具</li>
<li>Mind Hacks 有一个漫长的前生—一个有着近6年历史的技术博客</li>
<li>在CSDN上有超过120万的访问量</li>
</ul>
</blockquote>
<p>豆瓣书评：<a href="http://book.douban.com/subject/6709809/" target="_blank" rel="external">http://book.douban.com/subject/6709809/</a><br>PS：百度一下，有PDF版本可以下载</p>
<p>2015-12-18</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号（微信搜 McuProgramming ）主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>微信的编辑功能比较弱，不能贴链接，代码啥的，，，所有文章均发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-QT-MultiThread-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/17/QT-MultiThread-1/" class="article-date">
  	<time datetime="2015-12-17T09:08:29.000Z" itemprop="datePublished">2015-12-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/17/QT-MultiThread-1/">QT 多线程－Timer模拟</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="0_前言">0 前言</h4><p>利用Timer回调事件来模拟多线程效果</p>
<h4 id="1_基本思路">1 基本思路</h4><ol>
<li>在QTimer的回调事件中，关联一个任务函数，用于模拟独立线程</li>
<li>在独立线程中，更新计数器，并更新标签显示值</li>
<li>10S倒计时结束后，关闭定时器任务</li>
</ol>
<h4 id="2_效果">2 效果</h4><ol>
<li>截图<br><img src="http://cedar-renjun.github.io/images/2015/12/17/2.png" alt="开始界面框架图"><br><img src="http://cedar-renjun.github.io/images/2015/12/17/3.png" alt="软件运行中"></li>
<li>视频效果<br><a href="http://cedar-renjun.github.io/images/2015/12/17/4.mov">http://cedar-renjun.github.io/images/2015/12/17/4.mov</a></li>
</ol>
<h4 id="3_源码下载">3 源码下载</h4><p><a href="http://cedar-renjun.github.io/assets/2015/12/17/multi_thread_1.zip">http://cedar-renjun.github.io/assets/2015/12/17/multi_thread_1.zip</a></p>
<h4 id="4_注意事项">4 注意事项</h4><p>软件定时器，最多只能达到20ms的精度；需要更高精度时，必须调用系统硬件定时器</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QT/">QT</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-8-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/17/Day-8-USB/" class="article-date">
  	<time datetime="2015-12-16T16:04:44.000Z" itemprop="datePublished">2015-12-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/17/Day-8-USB/">Day 8 USB 总线架构</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>USB的架构如下所示</p>
<p><img src="http://cedar-renjun.github.io/images/2015/12/17/1.png" alt="USB框架图"></p>
<p>属于树形节点（星形）网络，HUB是树的根节点，Device表示叶子节点，HOST是根节点</p>
<p>USB设计的初衷就是为了构建以PC为中心的，连接各种外设硬件的网络；所以为了让USB接口占用的面积最少，设计了HUB逐级拓展的方式，然后利用PC 作为HOST，管理所有的设备</p>
<p>当然，这种单一主控的网络架构，导致的问题就是带宽利用率有限，外设增多之后，每个外设所得到的时间片会相应的缩小和延时抖动</p>
<p>现代PC机都会采用多个USB HOST的方式来缓解这个问题，USB设备分配到不同的USB网络中，从而避免了带宽冲突的问题</p>
<p>从整体上来看，USB属于半双工，单主机轮询机制；只有当主机轮询到对应的从机时，从机才可以发送数据，从机绝对不能主动发数据给主机</p>
<p>这就带来一个怎么处理紧急事务的问题：当某个设备需要紧急传输数据给主机时，只有等待下一个时间到来，虽然这个时间片可以设置很短，比如1ms，但这样增加了USB主机的查询负担</p>
<p>总结一下</p>
<p><strong>优点：</strong></p>
<ol>
<li>架构清晰，便于通过HUB拓展外设<br>能通过HUB来拓展至127个外设</li>
<li>USB主机控制整个总线带宽，可以合理的分配给不同的设备<br>设备带宽，电流单独可控</li>
<li>单主机机制，不需要复杂的主机协调协议<br>主机定时轮询，避免多机冲突</li>
<li>地址分配协议简单清晰<br>默认地址为0，主机统一分配地址</li>
</ol>
<p><strong>不足：</strong></p>
<ol>
<li>带宽使用率有限</li>
<li>从机只能被动的发送数据，对于紧急事件，延迟较高</li>
</ol>
<p>随着手机等可移动设备的普及，用户不仅希望手机能和电脑连接，也能连接外设（比如U盘，打印机），主机架构已经满足不了需求了</p>
<p>于是USB推出一个OTG功能，增加了主机协调协议，能在连接时，通过协商来确定谁当主机，谁当从机，从而解决了这个问题</p>
<p>下一篇分析USB怎么识别不同速度的外设</p>
<h3 id="每日推荐">每日推荐</h3><ol>
<li>ST巡讲会的USB资料<a href="http://sttext.eefocus.com/data/st/06/e3/9e/1371713070198251.pdf" target="_blank" rel="external">http://sttext.eefocus.com/data/st/06/e3/9e/1371713070198251.pdf</a></li>
</ol>
<p>2015-12-16</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号（微信搜 McuProgramming ）主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>微信的编辑功能比较弱，不能贴链接，代码啥的，，，所有文章均发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-usb-vbus-detect" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/16/usb-vbus-detect/" class="article-date">
  	<time datetime="2015-12-16T09:05:09.000Z" itemprop="datePublished">2015-12-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/16/usb-vbus-detect/">USB VBUS检测</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>重新设计了USB硬件，兼容所有F4系列64Pin封装芯片<br>但下载USB程序，PC检测不到USB设备</p>
<p>看了下ST提供的代码，主要是以下几个问题</p>
<ol>
<li>晶振问题<br>库使用的是25MHz晶振，我焊接的是8MHz晶振<br>代码修改如下<ol>
<li>#define PLL_M    8</li>
<li>#define HSE_VALUE    ((uint32_t)8000000) /<em>!&lt; Value of the External oscillator in Hz </em>/</li>
</ol>
</li>
<li>VBUS检测问题<br>默认情况下，STM32用PA9来检测VBUS电压，并设置对应的上拉模式<br>所以可以在OTG_FS_GCCFG寄存器中，置位NOVBUSSENS，关闭VBUS检测功能，强制使用上拉模式<br>这样，外部DP，DM就不需要使用1.5K上拉电阻</li>
</ol>
<p>手册摘录如下：</p>
<blockquote>
<p>Bit 21 NOVBUSSENS: VBUS sensing disable option<br>When this bit is set, VBUS is considered internally to be always at VBUS valid level (5 V). This option removes the need for a dedicated VBUS pad, and leave this pad free to be used for other purposes such as a shared functionality. VBUS connection can be remapped on another general purpose input pad and monitored by software.<br>This option is only suitable for host-only or device-only applications.<br>0: VBUS sensing available by hardware<br>1: VBUS sensing not available by hardware.</p>
</blockquote>
<p><strong>参考资料</strong></p>
<ol>
<li><a href="http://sttext.eefocus.com/data/st/06/e3/9e/1371713070198251.pdf" target="_blank" rel="external">STM32 OTG_FS/HS 模块</a></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-libusb-on-mac" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/14/libusb-on-mac/" class="article-date">
  	<time datetime="2015-12-14T12:05:27.000Z" itemprop="datePublished">2015-12-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/14/libusb-on-mac/">MAC环境下，QT上使用libusb</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基本步骤</p>
<ol>
<li><code>git clone https://github.com/libusb/libusb.git</code></li>
<li><code>./configure</code></li>
<li><code>./make</code></li>
<li><code>sudo ./make install</code></li>
<li>在qt工程文件(pro)中，添加下面两句<br><code>LIBS        += -L/usr/local/lib   -lusb-1.0.0</code><br><code>INCLUDEPATH += /usr/local/include</code></li>
<li>在代码中使用<code>#include&lt;libusb-1.0/libusb.h&gt;</code></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-7-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/13/Day-7-USB/" class="article-date">
  	<time datetime="2015-12-13T15:54:13.000Z" itemprop="datePublished">2015-12-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/13/Day-7-USB/">Day 7 USB 咬文嚼字</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天花10分钟，来分析USB（universal serial bus）的名字：<strong>通用，串行，总线</strong></p>
<h4 id="1_通用">1 通用</h4><p>指物理层和数据链路层上，可以通过USB接口来跑很多种应用层协议</p>
<h4 id="2_串行">2 串行</h4><p>底层通讯的关键因素是：</p>
<ol>
<li>通信时钟速率</li>
<li>bit同步</li>
<li>帧同步</li>
<li>数据线数量</li>
<li>bit层编码协议</li>
</ol>
<p>根据数据线的数量不同，可以分为串行和并行<br>串行在一个时钟驱动下，能传输一个bit信号；并行能同时传输多个bit信号</p>
<p><strong>通信速率</strong><br>并行数据线在跑高速信号时，对环境条件要求比较高，容易因为布线，阻抗，ESD干扰等，导致多条数据线路到达终端的时间不一致，这就是数据时间窗口的问题，从而限制了通信时钟最大的速率</p>
<p>串行总线因为只需要同步采样一路数据线的电信号，就没有了时间窗口的问题，所以串行速率会有几个数量级的提升。同时可以采用差分线来增加抗干扰能力，采用NRZI编码来省掉一个时钟线，更能提高传输速率</p>
<p><strong>bit 同步</strong><br>底层通讯时，必须考虑bit同步问题，也就是在通讯过程中，怎么区分数据线上的各个bit</p>
<ol>
<li>SPI，I2C这类，采用增加时钟线的方式来同步，一个时钟跳变沿，就是一个采样同步信号</li>
<li>UART这类，靠时间片的方式来同步，每个时间片都是nUs，时间一到，就读取数据线信号。但这种方式，容易有时间积累效应，导致漂移和误差，从而采样错位。因此UART也会有一个帧同步的机制，来定时复位采样时间电路，从而将误差限制在可控范围内</li>
<li>红外，1-wire这种单线制信号，是采用脉宽和特定模式，来一起解决bit同步和帧同步问题</li>
<li>USB这种呢，则是将利用数据信号的跳变过程来同步，所以没有单独的时钟线，叫NRZI。但这种机制，本质上还是和UART的时间片方式一样，所以对于一连相同的特定数字信号，仍然会出现漂移，错位的现象，所以USB协议通关强制插入反转序列的方式，来给SIE状态机一个时钟同步信号。这样的效果就是可以显著提高通行速率。<br>理论上来说，同步反转信号插入的越多，通讯同步误差就会越小，通讯速率越高，但是会导致有效带宽使用率下降的问题，所以要适当的权衡。</li>
<li>还有一种，对于射频信号，会采用频率调制，用特定的频率来表示0，1</li>
</ol>
<h4 id="帧同步">帧同步</h4><p>很多同学，可能不知道这个概念，其实，很简单<br>bit同步用于保证系统能识别一连串的010101，但是我们把这些01分组呢？<br>帧同步就是干的这事</p>
<p>另一个名字，帧开始，帧结束，可能各位比较熟悉一些，</p>
<p>UART会用数据线第一个下降沿来表示帧传输开始，上升沿表示帧结束<br>SPI就是默认的8个，16个，32个clock表示一个帧，挨个数就行了<br>其它通讯总线的方式，也类似</p>
<p>当初USB设计的初衷就是为了高速应用，所以选择了串行，差分，NRZI编码通讯方式</p>
<h4 id="3_总线">3 总线</h4><p>USB采用层次化总线拓扑方式，就是多叉树形结构<br>涉及到总线，就会提及几个关键点</p>
<ol>
<li>寻址方式</li>
<li>应答机制</li>
<li>通讯协议</li>
</ol>
<p>时间不够，就不展开了，明天聊</p>
<h3 id="每日推荐">每日推荐</h3><ol>
<li>Sparkfun上，关于串行通讯的<a href="https://learn.sparkfun.com/tutorials/serial-communication" target="_blank" rel="external">入门介绍</a></li>
<li>Northeastern University的<a href="http://www.ccs.neu.edu/home/amislove/teaching/cs4700/fall09/lectures/lecture6.pdf" target="_blank" rel="external">数据链路层资料</a></li>
<li>CSDN博客文章-<a href="http://blog.csdn.net/yiwuya/article/details/4136319" target="_blank" rel="external">串行通信比并行通信的速度更高</a></li>
</ol>
<p>PS：可能某些资料需要翻墙才能查看，如需帮助，请告诉我</p>
<p>2015-12-13</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号（微信搜 McuProgramming ）主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>微信的编辑功能比较弱，不能贴链接，代码啥的，，，所有文章均发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-6-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/12/Day-6-USB/" class="article-date">
  	<time datetime="2015-12-12T15:57:40.000Z" itemprop="datePublished">2015-12-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/12/Day-6-USB/">Day 6 USB 可插拔</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1_什么是可插拔？">1 什么是可插拔？</h4><blockquote>
<p>热插拔（hot-plugging或Hot Swap）即带电插拔，热插拔功能就是允许用户在不关闭系统，不切断电源的情况下取出和更换损坏的硬盘、电源或板卡等部件，从而提高了系统对灾难的及时恢复能力、扩展性和灵活性等，例如一些面向高端应用的磁盘镜像系统都可以提供磁盘的热插拔功能。具体用学术的说法就是：热替换（Hot replacement）、热添加（hot expansion）和热升级（hot upgrade）</p>
</blockquote>
<p>以上来百度百科</p>
<h4 id="2_可插拔的好处？">2 可插拔的好处？</h4><p>对用户来说，可插拔的最大好处就是，安装外设再也不用重启电脑了，，，，<br>对系统来说，实现了动态扩充，动态增加功能的好处</p>
<h4 id="3_可插拔架构实现的关键">3 可插拔架构实现的关键</h4><ol>
<li>设备检测机制</li>
<li>状态可控</li>
<li>设备自我解释</li>
</ol>
<p>不好理解是不，举个栗子<br>北影旁边有个看门大爷，负责管理后台演出人员，每天8点，大爷都会点一点人数，把姓名，特长，座位记到一个小本子上，然后给一个小板凳，让他们坐着，等导演召唤</p>
<p>导演需要人时，大爷就翻一翻本子，说：A，53号那个，过来，导演叫你呢</p>
<p>大爷年老眼花，所以日子一长，就出问题了<br>有一天，大爷没注意到一个人走了，然后导演找不到人演戏，就罢工不干了<br>有一天，后台溜进来一个新人，大爷看到他，他也没凳子坐，就一直捣乱；直到第二天大爷重新点人数时，才发现他，给了一个凳子，安抚好<br>有一天，后台两人打架，一把火把后台烧了。。。</p>
<p>（这就是原来的电脑不可插拔机制，硬件损坏蓝屏，必须重启安装驱动，硬件冲突蓝屏）</p>
<p>怎么解决呢？</p>
<p>导演找了两个年轻人，一个保安来辅助大爷，一个看前门，一个看后门；一个年轻人看管前门，另外一个看管后门，保安负责看场子<br>大爷再也不用在早8点一个一个点名了，只需要坐在座位上记录就好了<br>每当有人从前门进来时，年轻人都会问一遍基本信息，然后安排一个座位，然后大声喊：大爷，新来了一个人，叫XXX，演爱情剧的，我安排到2号座位了啊<br>大爷就记下了<br>每当有人要从后门离场时，另外一个人，就会把座位收了，然后大声喊：大爷，那个XXX的，有事走了，我把2号座位收了啊<br>大爷然后找到本子的那一页，画一个叉号<br>半小时后，保安说，8号的那个SB，闹事了，本来谈好的300工资，非要800，我把他赶出去了<br>大爷说，好，然后找到8号的那页，又画了一个叉号</p>
<p>管理有序，来了再多人也不会乱</p>
<p>关键点在于</p>
<ol>
<li>改进了流程，从每天检查一次，改为随时检查更新记录，进一个检查一个<br>从而杜绝了，有记录找不到人的情况（DM/DP设备检测机制）</li>
<li>增加了两个看门人，保证了能及时监测到人员进出，根据人数及时调整记录（动态更新机制）</li>
<li>增加了保安，降低了闹事，砸场子的可能（限制设备最大电流，最大带宽）</li>
</ol>
<p>从技术层面来说</p>
<p>一个设备的关键信息有</p>
<ol>
<li>设备文字性信息（演员叫什么，家在哪里，毕业哪个学校）</li>
<li>设备功能和资源要求（演员能演什么）</li>
<li>设备系统地址（座位号）</li>
<li>设备数据协议和行为规范（导演与演员的语言交流）</li>
</ol>
<p>操作系统在开机自检后，将硬件信息保存到注册表中，然后提供一个设备查询接口供驱动软件来使用。也就是说系统在开机后，就已经记录了当前系统中所有设备的文字性描述信息，功能和基本资源需求，设备地址！并且这个更新记录过程只发生在开机阶段，所以要添加设备，就只有重启系统了</p>
<p>如果我们把这个查找过程推迟一步呢？<br>那就变成了：只有当设备插入，拔出时，系统才会更新这个设备记录表，匹配对应的设备驱动</p>
<p>这样就把记录更新触发条件从&lt;上电启动&gt;变成了&lt;设备插拔&gt;，从而实现了热插拔效果</p>
<p>所以，从本质上来说，热插拔就是延迟管理，事件触发的技术</p>
<p>这种延迟绑定技术，在计算机技术中大量存在，比较典型的例子是动态链接技术，将函数，变量地址绑定过程，从编译阶段延迟到了运行阶段，进行达到了解耦，动态升级，共用基础设备的效果</p>
<blockquote>
<p>稍微讲一下动态链接的过程吧<br>在程序运行之前，系统先调用Dynamic Link Loader，递归下降找到程序中用到的所有dll库，然后加载到内存中，如果内存中已经有了dll，则忽略；完成这一步后，loader把dll的内存地址记录下来，然后释放控制权，接着构建程序运行环境，比如初始化堆栈，内存，分配变量空间啥的，然后开始运行程序；当程序遇到未绑定的变量或者函数地址时，会跳转到PLT，然后PLT跳转到GOT，GOT里面默认就是Loader的入口地址，所以Loader再次接管控制权，到dll中的符号表中，找对应的符号，找到后，则用这个新地址更新PLT和GOT，接下来就是被调用的函数接管控制权；<br>当第二次调用时，因为GOT，PLT表里面已经包含了有效地址，所以就无需loader介入，直接查表，跳转就好了</p>
</blockquote>
<p>再次回到热插拔的话题</p>
<p>总结起来，就是</p>
<ol>
<li>改变了触发设备更新的条件，每次插拔都会更新，相当于两次完整的重启过程（一次注册更新，一次注销更新）</li>
<li>延时了设备数据获取的阶段，每次检测到设备插入时，都必须重新获取所有设备信息，从而保证设备状态的可控性</li>
</ol>
<p>当然，在硬件层面，也要做很多额外的工作，比如增加电源缓冲，提高数据传输速率，增加ESD保护</p>
<h4 id="4_USB协议中，插入USB设备后，PC为什么会要求USB设备重启？">4 USB协议中，插入USB设备后，PC为什么会要求USB设备重启？</h4><p>熟悉USB协议的朋友，都会知道PC在检测到设备插入时，都会要求USB设备重启，为什么这样要求呢？</p>
<p>热插拔带来的另外一个问题：怎么维护设备的操作状态，并保证设备始终处于可控状态</p>
<p>可控是指设备具有确定性，在特定环境下，对特定的输入，设备要做出完全一致的，可重复的特定输出</p>
<p>原来的设备状态信息，由操作系统内部来维护，比如上电后，会请求外设复位，然后进行初始化，从而进入确定的状态，等待系统命令。</p>
<p>但对于可插拔设备呢，在插入后，设备默认地址为0，同时系统会要求设备进行复位，从而让设备清除旧状态信息，进入确定的可控状态。</p>
<p>so bad，还是没引入状态机的理论</p>
<h3 id="每日推荐">每日推荐</h3><ol>
<li>[QP量子架构]<a href="http://www.state-machine.com/index.html" target="_blank" rel="external">http://www.state-machine.com/index.html</a><br>状态机编程的经典书籍</li>
</ol>
<p>2015-12-12</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号（微信搜 McuProgramming ）主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>微信的编辑功能比较弱，不能贴链接，代码啥的，，，所有文章均发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-STM32-Hardware-Design" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/12/STM32-Hardware-Design/" class="article-date">
  	<time datetime="2015-12-12T08:18:10.000Z" itemprop="datePublished">2015-12-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/12/STM32-Hardware-Design/">STM32 硬件设计</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近画了一些板子，原本的MCU是用STM32F446RET6，样板打出来后，发现物料不好买，问了一些代理商，因为这个片子比较新，所以都没有货，只好换405系列的</p>
<p>不过，ST的软硬件兼容性做的不错，软件基本不用动，硬件修改几个电源管脚就OK</p>
<p>在此记录一下</p>
<h3 id="1_STM32F446和STM32F405/7的区别">1 STM32F446和STM32F405/7的区别</h3><p>405是168MHz的M4内核芯片，407相对于407增加了以太网和相机接口，405和407的FLASH有两种：512/1024K</p>
<p>而446是新推出的片子，可以说是407的缩水版，把主频提高到了180M，但没有以太网接口，相机接口，FLASH的size也有相应的缩写，最大512K，所以从长远来看，446的价格会相对便宜一些；从ST官网来看，大概比405便宜1个美金的样子</p>
<p>官方给出的摘要</p>
<blockquote>
<p>STM32F446 – 180 MHz/225 DMIPS, up to 512 Kbytes of Flash with dual Quad SPI and SDRAM interfaces<br>STM32F407/417 – 168 MHz CPU/210 DMIPS, up to 1 Mbyteof Flash adding Ethernet MAC and camera interface<br>STM32F405/415 – 168 MHz CPU/210 DMIPS, up to 1 Mbyte of Flash with advanced connectivity and encryption</p>
</blockquote>
<p>详细的对比信息，点击这里<br><a href="http://www.st.com/web/catalog/mmc/FM141/SC1169/SS1577" target="_blank" rel="external">http://www.st.com/web/catalog/mmc/FM141/SC1169/SS1577</a></p>
<p>软件方面，完全兼容</p>
<h3 id="2_F4系列硬件兼容性">2 F4系列硬件兼容性</h3><p>对于F4系列LQFP64封装来说，只有446和11系列的CAP管脚布局和其它F4芯片不同，需要特别注意，如下所示</p>
<p><img src="http://cedar-renjun.github.io/images/2015/12/12/1.png" alt="F4管脚区别"></p>
<p>主要是CAP管脚的问题，405/7带有两个CAP脚（31，47），446只带一个CAP（30）</p>
<p>硬件手册要求：</p>
<ol>
<li>CAP脚必须接电容到地平面</li>
<li>一个CAP的芯片，直接接一个4.7uF电容</li>
<li>两个CAP的芯片，每个管脚接一个2.2uF的电容</li>
<li>VSS必须要接地</li>
</ol>
<p>为了兼容所有F4的硬件，建议这样设计</p>
<p><img src="http://cedar-renjun.github.io/images/2015/12/12/2.png" alt="兼容设计"></p>
<p>在需要使用446芯片时：</p>
<ol>
<li>把31，47管脚的电容换成0欧电阻</li>
<li>把30管脚接4.7uF电容</li>
</ol>
<p>在需要使用其它F4时：</p>
<ol>
<li>把31，47管脚的电容换成2.2uF电容</li>
<li>30脚悬空</li>
</ol>
<h3 id="3_去耦电容">3 去耦电容</h3><p>计算公式：10uF＋Nx100nF<br>N是VDD管脚的个数，有多少个VDD，就有多少个100nF<br>电容尽量靠近MCU，布线时，记得先过电容，然后才是芯片的管脚，不然就没有效果了</p>
<h3 id="4_电源部分">4 电源部分</h3><p>这部分没什么说的，3.3V接到VDD，VDDA就好。<br>特别注意：VDDA是必须要接的，不要因为你没有用ADC，就不接这个管脚。因为STM32的PLL时钟电路，是由VDDA模拟部分供电的，没有供电，就没有系统时钟信号，后果自己想</p>
<h3 id="5_复位电路">5 复位电路</h3><p>常见的错误：在STM32外部增加一个阻容复位电路，上拉至VDD。<br>STM32内部已经有复位电路和上拉电路，所以完全没有必要额外的添加上拉电阻，只需要添加一个100nF的电容接地，目的是滤除外部的干扰信号，防止偶然触发MCU复位</p>
<h3 id="6_调试接口">6 调试接口</h3><p>对于调试接口来说，建议采用SWD接口，只需要引出DIO和CLK两个pin就可以调试。<br>对于一般应用来说，足够了。但对于可靠性设计来说，有两个细节要处理</p>
<ol>
<li>要不要引出RESET管脚？<br>因为STM32允许通过软件的方式禁用JTAG／SWD接口，所以，某些产品级别的代码会在上电后，关闭调试接口，禁止FLASH读，从而防止固件被盗取。<br>但是，如果MCU在上电后，立刻关闭JTAG／SWD接口，就会致使再也无法通过调试器来访问MCU，就是所谓的芯片锁死。<br>为了防止出现这样的事故，建议引出来RESET接口，从而可以让调试器控制RESET线，让MCU进入调试状态，避免锁死</li>
<li>要不要加上拉／下拉电阻？<br>很多开发板或者其它的网上原理图，都会在外部添加一个10K的上拉或者下拉电阻，其实这是完全没有必要的。因为STM32内部已经集成了上拉／下拉电阻。<br>如下所示<br>PA13 — JTMS/SWDIO — Internal pull-up<br>PA14 — TCK/SWCLK — Internal pull-down</li>
</ol>
<h3 id="参考资料">参考资料</h3><ol>
<li><a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/application_note/DM00115714.pdf" target="_blank" rel="external">AN4488 Getting started with STM32F4xxxx MCU hardware development</a></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32/">STM32</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-5-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/11/Day-5-USB/" class="article-date">
  	<time datetime="2015-12-11T14:27:22.000Z" itemprop="datePublished">2015-12-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/11/Day-5-USB/">Day 5 USB 软件？硬件？</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上篇提到了USB协议出现之前的社会背景，人们希望PC外围设备的特点是</p>
<ol>
<li>外设的接口都一样</li>
<li>安装新设备后，不要再重启电脑才能使用</li>
<li>速率更快</li>
<li>通信线材足够简单</li>
<li>要兼容旧驱动，软件</li>
</ol>
<p>简单来说，就是在一个新的接口内包容所有的旧设备接口</p>
<p>软硬件不分家，随着技术的发展，工程师会把一些软件功能，用硬件实现，硬件加速器就是非常典型的例子；同时呢，对于需要更高灵活度的任务，硬件无法完美处理的，工程师会在软件层面来实现这些东西</p>
<p>原来的PC接口是：硬件复杂，软件简单<br>现在人们希望是：硬件简单，软件复杂<br>用户只想要简单的使用就好，用户不想关心技术，你们工程师搞定就好<br>从而导致设计重心偏向软件方向</p>
<p>更深层次的讲，导致这种变化的因素是：消费市场供应方的增加，供大于求，导致消费者话语权的增加，迫使厂商为了迎合消费者不得不推出新的技术方案，从而反向的推动技术发展</p>
<p>Repeat 核心思想：硬件简单，软件复杂</p>
<p>解决的方案就是增加两个层</p>
<ol>
<li>往下增加一个层，<strong>最底层的硬件接口层（USB接口）</strong></li>
<li>往上提高一个层，<strong>软件适配层（Warper）</strong></li>
</ol>
<p>标准的底层硬件接口层用于传输通信数据流，然后发送到上层Warper接口，Warper接口负责理解数据的含义，并分发到对应的上层驱动，从而保持原有驱动不变</p>
<p>这么说，可能不好理解，举个栗子</p>
<p>到政府办事的时候，经常要跑很多科室，盖很多章，这些科室有专门的职责；后来有一天，政府推出了一个网站，说，你们不用来回跑了，直接在网上提交材料就好，全程网上处理；对于我们来说，只需要登陆一个电脑网站就能办所有事</p>
<p>N个科室－－进化－－&gt;网上虚拟科室</p>
<p>但办事流程还和原来的一样，我们依然很熟悉，不需要任何转换学习成本</p>
<p>科室从硬件实体，变成了虚拟的一个图标</p>
<p>USB的角色也是类似，将传统的硬件串口，硬件打印机接口等等，通通变成软件接口</p>
<p>或者理解为：肉体消失了，但灵魂从未消散</p>
<p>硬件下降一个层次，软件提高一个层次</p>
<p>当然，在增加层次的过程中，有几个关键技术细节要处理</p>
<ol>
<li>如何实现热插拔？</li>
<li>为什么采用一个主机的总线架构？</li>
<li>如何提高传输速率？</li>
<li>如何兼容旧驱动架构？</li>
</ol>
<p>明天聊一下：热插拔机理</p>
<p>PS：里面涉及到状态机和数据管理权下放的问题</p>
<h3 id="每日推荐">每日推荐</h3><ol>
<li>状态机（FSM/HSM）<br>如果一个嵌入式软件工程师，连状态机都没听过，说明他的Level连入门都没达到，请反思；<br>更多资料，请自行搜索”有限状态机”，”层次状态机”</li>
</ol>
<p>2015-12-11</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号（微信搜 McuProgramming ）主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>微信的编辑功能比较弱，不能贴链接，代码啥的，，，所有文章均发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-eye-pattern" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/10/eye-pattern/" class="article-date">
  	<time datetime="2015-12-10T04:54:46.000Z" itemprop="datePublished">2015-12-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/10/eye-pattern/">示波器眼图</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1_眼图是什么？">1 眼图是什么？</h3><p>在实际系统中，完全消除码间串扰是十分困难的，而码间串扰对误码率的影响目前尚无法找到数学上便于处理的统计规律，还不能进行准确计算。为了衡量基带传输系统的性能优劣，在实验室中，通常用示波器观察接收信号波形的方法来分析码间串扰和噪声对系统性能的影响，这就是眼图分析法。眼图是一系列数字信号在示波器上累积而显示的图形，它包含了丰富的信息，从眼图上可以观察出码间串扰和噪声的影响，体现了数字信号整体的特征，从而估计系统优劣程度，因而眼图分析是高速互连系统信号完整性分析的核心。另外也可以用此图形对接收滤波器的特性加以调整，以减小码间串扰，改善系统的传输性能</p>
<h3 id="2_眼图的关键参数是什么？">2 眼图的关键参数是什么？</h3><p>如眼高、眼宽、眼幅度、眼交叉比、“1”电平，“0”电平，消光比，Q 因子，平均功率等</p>
<p>详情请参考<a href="http://baike.baidu.com/view/1227430.htm" target="_blank" rel="external">百度百科</a></p>
<h3 id="3_基本原理">3 基本原理</h3><p>对于含有Clock线的通信链路来说，直接用Clock的跳变沿做触发信号，然后显示Data波形，接着用余晖的方式多次叠加波形，就可以得到眼图效果</p>
<h3 id="4_我的示波器能显示眼图吗？">4 我的示波器能显示眼图吗？</h3><p>任何实时显示示波器，都能显示眼图<br>Tek有个<a href="http://cn.tek.com/support/faqs/it-possible-display-eye-pattern-my-oscilloscope" target="_blank" rel="external">FAQ</a>，可以解释这个问题</p>
<p>IS IT POSSIBLE TO DISPLAY AN EYE PATTERN ON MY OSCILLOSCOPE?</p>
<p>Any real-time scope can display an eye with varying degrees of clarity. The faster the scope is able to re-trigger, the clearer the eye.</p>
<p>To display an eye, first adjust the settings so that you are able to see one period and center it in the display. We are using a signal at a data rate of 200MHz (1 UI = 5nsec), so we will set our timebase to 1nsec/div.</p>
<p><img src="http://www.tek.com/Measurement/GIFs/faq/0918/1.jpg" alt="Fig1"><br>Figure 1: Your data signal</p>
<p><img src="http://www.tek.com/Measurement/GIFs/faq/0918/2.jpg" alt="Fig2"><br>Figure 2: One period of your data signal</p>
<p>Now adjust the position or horizontal delay so that the period being viewed is not the edge being triggered. It is usually best to center on the third or fifth UI after the trigger. In this case the third UI starts on 15nsec, so the center of the UI will be 15nsec + ½ of a UI = 17.5nsec.</p>
<p><img src="http://www.tek.com/Measurement/GIFs/faq/0918/3.jpg" alt="Fig3"><br>Figure 3: Adjust the horizontal position or delay to the third or fifth UI</p>
<p>Now go into the display menu and turn on variable persistence to see both the positive and negative transitions of the period at a given unit interval.</p>
<p><img src="http://www.tek.com/Measurement/GIFs/faq/0918/4.jpg" alt="Fig4"><br>Figure 4: Final eye diagram using persistence mode</p>
<p>In addition, you can use FastAcq mode or WaveformDB mode to create a color graded display of your eye.</p>
<p><img src="http://www.tek.com/Measurement/GIFs/faq/0918/5.jpg" alt="Fig5"><br>Figure 5: Eye diagram using FastAcq mode</p>
<h3 id="5_参考资料">5 参考资料</h3><ol>
<li><a href="http://www.onsemi.cn/pub_link/Collateral/AND9075-D.PDF" target="_blank" rel="external">Understanding Data Eye Diagram Methodology for Analyzing High Speed Digital Signals</a></li>
<li><a href="https://en.wikipedia.org/wiki/Eye_pattern" target="_blank" rel="external">Eye Pattern Wiki</a></li>
<li><a href="http://baike.baidu.com/view/1227430.htm" target="_blank" rel="external">百度百科</a></li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/示波器/">示波器</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-4-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/09/Day-4-USB/" class="article-date">
  	<time datetime="2015-12-09T13:00:21.000Z" itemprop="datePublished">2015-12-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/09/Day-4-USB/">Day4 USB的历史因素</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​<br>回顾一下，昨天的故事</p>
<blockquote>
<p>你到政府部分办事，首先需要找到办事窗口，然后告诉TA你是谁，能办什么事，来办什么事，然后把你的手机号，邮箱告诉TA    </p>
<p>接着，办事人员给你一个登记号，然后说，记下了，稍后我会派专员联系你</p>
<p>然后，你就回家了，等着电话，10分钟后，电话来了，对话如下</p>
<p>办事专员：我是XX号客服，你是不是YY，登记号是ZZ</p>
<p>你           ：是的<br>办事专员：巴拉巴拉<br>你           ：巴拉巴拉</p>
<p>最后，通话结束</p>
</blockquote>
<p>上面的事情，细化一下，完全可以套用到USB通讯过程</p>
<ol>
<li>你到政府部分办事，首先需要找到办事窗口（插入USB设备）</li>
<li>然后窗口接待人员问了你一些基本信息，姓名，性别（USB主机主动获取设备描述符）</li>
<li>帮你取了个号（设置USB设备地址），突然把你名字忘了，哎，那谁，XYZ号，你叫啥名儿？办什么事？你只好又重复一遍（USB主机主动获取设备描述符，配置描述符，接口描述符，端点描述符）</li>
<li>办事人员，最后问你家在哪，电话号码多少（USB主机记录接口描述符，端点描述符）</li>
<li>接着，TA说，好，记下了（注册USB设备到系统），稍后我会派专员联系你（匹配USB驱动），你可以回家了，保持电话畅通（等待端口事件）</li>
<li>然后，你就回家了，等着电话，10分钟后，电话来了（发生数据交互）<br>对话如下</li>
<li>办事专员：我是XX号客服，你是不是YY，登记号是ZZ（确定USB设备地址，端口地址）</li>
<li>你           ：是的<br>办事专员：巴拉巴拉<br>你           ：巴拉巴拉<br>（PC与USB设备发生数据交换）</li>
<li>最后，通话结束（结束通信）</li>
</ol>
<p>PS：上面的有一些术语，看不懂没关系，暂时忽略。重点关注整个交互流程</p>
<p>技术的产生和发展，都是跟当时社会的整体环境相适应的；这一点在IT技术上尤其明显</p>
<p>先了解USB 技术的历史背景，然后再想想USB解决了什么问题，就能理解USB架构为什么这样设计了</p>
<p>我一直认为：技术架构，从任何部分来看，都是很简单的<br>真正的困难在于，技术要求精确，所以会有大量细节性知识，精确描述性术语，把整体架构给掩盖住了</p>
<p>类似盲人摸象，这有俩洞，是啥玩意？？？摸了半天，发现是个鼻子，，，<br>再摸大象腿，最后耳朵，最后摸了一遍<br>然后在脑海里拼了半天，我擦，这玩意就是个大象</p>
<p>学技术也是类似的情况，先远观，掌握大致轮廓，然后慢慢细究，根本没有解决不了的技术问题</p>
<p>OK，回到USB的历史</p>
<p>几年前，电脑上有RJ45网口，DB9串口，视频输出口，打印机并口，还有光盘啥的，反正电脑上有各种形状的接口</p>
<p>后来消费者一看，妈蛋，这玩意不行啊，包里一堆线，不好插，体积也大，要搞死了<br>PC大厂一看，擦，这是个机会啊，我先推出小接口的电脑，就能搞死对手</p>
<p>然后，问题就来了</p>
<ol>
<li>微软说了，你们随便搞，反正我要原来的电脑软件还要能用，驱动还能用，不然搞死你们</li>
<li>消费者说了，电脑上别有各种形状的接口，要简单，要速度快，不然买别家电脑去</li>
<li>工厂说了，线材制作要简单，线越少越好，不要良品率低，自己看着办</li>
</ol>
<p>一帮IT大神，微微一笑，小case</p>
<blockquote>
<p>硬件不够，软件来凑</p>
</blockquote>
<p>然后就把这个问题轻轻松松搞定了</p>
<p>怎么解决的？明天继续</p>
<h3 id="每日推荐">每日推荐</h3><blockquote>
<p>任何计算机问题，都能通过增加一个层来解决</p>
</blockquote>
<p>CSAPP上看的，忘了谁说的了，反正是个牛逼的人物</p>
<p><a href="http://www.amazon.cn/Computer-Systems-A-Programmer-s-Perspective-Bryant-Randal-E/dp/0136108040/ref=sr_1_5?s=books&amp;ie=UTF8&amp;qid=1449665814&amp;sr=1-5&amp;keywords=Computer+Systems%3A+A+Programmer%27s+Perspective" target="_blank" rel="external">CSAPP - Computer Systems: A Programmer Perspective </a></p>
<p>这是本神书，1300多页，CSAPP的介绍请百度或者google，据说看完的都成为大神了</p>
<p>国内有俩研究生，看完这本书的某几个章节，然后写了一本书《程序员的自我修养－编译，链接，库》</p>
<p>哦，我现在还没看完，，，</p>
<p>英文原版（299元）非常通俗易懂，千万不要买中译本，翻译的太垃圾，，，</p>
<p>2015-12-9</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号（微信搜 McuProgramming ）主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>微信的编辑功能比较弱，不能贴链接，代码啥的，，，所有文章均发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-Day-3-USB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/08/Day-3-USB/" class="article-date">
  	<time datetime="2015-12-08T15:04:52.000Z" itemprop="datePublished">2015-12-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/08/Day-3-USB/">Day3 USB的通俗解释</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>做个小游戏，仔细回想一下两年前做的项目，看能否记得所有细节</p>
<p>估计90%的人只记得功能性层面的东西，比如项目是干嘛的，解决什么问题的，至于编程语言层面的细节，早已经忘的一干二净</p>
<p>所以，我不会一上来就给你一大堆各种专业术语，然后陷入USB技术细节<br>这么做的结果是，你听不懂，也记不牢，半个月后，脑袋里面，一片空白，毛都不剩</p>
<p>我们学习一个新事物，只有先有感性认识，有了大致轮廓，然后类比其它事物，比较之后，才会在大脑中建立起系统整体架构</p>
<p>这是由大脑的运行机制来决定的，大脑不会记忆太多细节，越高层，处理的越事情越抽象</p>
<p>公司也是同样的机制，高层管理者只关心企业战略，不会考虑程序员的代码风格是否规范，合理</p>
<p>ok，先看下面一则小故事</p>
<p>很简单，还记得上篇的提示么，多想想现实社会的办事流程</p>
<p>你到政府部分办事，首先需要找到办事窗口，然后告诉TA你是谁，能办什么事，来办什么事，然后把你的手机号，邮箱告诉TA</p>
<p>接着，办事人员给你一个登记号，然后说，记下了，稍后我会派专员联系你</p>
<p>然后，你就回家了，等着电话，10分钟后，电话来了，对话如下</p>
<p>办事专员：我是XX号客服，你是不是YY，登记号是ZZ<br>你           ：是的<br>办事专员：巴拉巴拉<br>你           ：巴拉巴拉</p>
<p>最后，通话结束</p>
<p>思考几个问题：</p>
<ol>
<li>政府为什么要设立统一的接待入口？</li>
<li>办事人员怎么联系你？</li>
<li>如果这时来了另外一个人来办事，政府需不需要另外增加一个办事窗口？</li>
</ol>
<p>OK，咱们明天继续</p>
<h3 id="每日推荐">每日推荐</h3><ol>
<li><a href="http://www.amazon.cn/%E5%B5%8C%E5%85%A5%E5%BC%8F%E9%80%9A%E4%BF%A1%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1-%E6%96%AF%E7%91%9E%E5%BE%B7%E5%93%88/dp/B0011APWUQ/ref=sr_1_9?s=books&amp;ie=UTF8&amp;qid=1449584809&amp;sr=1-9&amp;keywords=%E5%B5%8C%E5%85%A5%E5%BC%8F+%E9%80%9A%E4%BF%A1" target="_blank" rel="external">嵌入式通信软件设计</a><br>斯瑞德哈(T.Sridhar) 写的，协议栈的核心就是状态机，更大的说，计算机的核心就是状态机，想要深入研究协议栈实现机制的同学，可以买一本这书翻翻，很薄的一本书，干货儿不少。建议这本书配合着USB协议栈源码或者LwIP源码一起看</li>
</ol>
<p>PS：买计算机书籍，记得选这种红皮的，或者这种<a href="http://www.amazon.cn/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%9B%E4%B9%A6-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F-%E5%B8%83%E8%8E%B1%E6%81%A9%E7%89%B9/dp/B004BJ18KM/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1449586593&amp;sr=1-1&amp;keywords=CSAPP" target="_blank" rel="external">CSAPP</a>黑皮的</p>
<p>2015-12-8</p>
<p>－－－－－分割线－－－－－<br><strong>注意事项</strong></p>
<ol>
<li><p>本订阅号主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
<li><p>所有文章发表在个人博客，可以通过点击原文来查看，原文有代码语法高亮，显示图片，带链接等效果</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-usb-reference-docunment" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/07/usb-reference-docunment/" class="article-date">
  	<time datetime="2015-12-07T13:54:27.000Z" itemprop="datePublished">2015-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/07/usb-reference-docunment/">USB 参考资料</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>注意</strong></p>
<ol>
<li><p>本订阅号主要发布一些嵌入式相关的知识和技巧，涉及到软件，硬件，射频，协议栈等；如果您有感兴趣的领域，请通过回复订阅号告诉我</p>
</li>
<li><p>本订阅号主要是简单文字为主，内含少量代码段，但绝不会发布大量的代码。<br>因为根据自己的体会，在手机微信端看代码的体验非常糟糕，一方面屏幕比较小，显示效果不好；另一方面，玩手机时，精力不会集中，更不会有大量时间。<br>cedar-renjun.github.io 个人博客会发一些技术细节的东西，感兴趣的，可以深入研究这里的博文</p>
</li>
</ol>
<h3 id="0x00_一点废话">0x00 一点废话</h3><p>在列USB参考资料之前，先聊一点废话</p>
<p>从09年大二时，就买了一本《USB应用程序开发》，很不幸，当时没看懂，对我来讲，完全是天书，各种传输层次，太复杂了，脑容量不够，于是就放下了，现在那本书还在书柜里躺着，罪过，罪过</p>
<p>后面一直折腾单片机，从51，到AVR，到STM32，到TI的LM3S9B96，飞思卡尔的KL系列，东芝的片子，接触了很多MCU</p>
<p>越来越有种感觉：天下大同</p>
<p>计算机，公司，管理理论，行业，社会，自然界，表面是不相干的领域，但深入一层，发现背后的机理，完全相同</p>
<p>嵌入式是人来开发的，人离不开社会，所以社会的层次和架构，甚至哲学思想，会同样映射到嵌入式系统中，构建一个虚拟的数字社会</p>
<p>对此，推荐一本书《计算机的心智(操作系统之哲学原理)》，这本书对整个架构，社会映射机制解释的很好，可以说是彻底改变了我的计算机思想层次</p>
<pre><code>有时候，遇到解决不了，想不通的计算机问题，不妨观察一下现实社会，人是怎么解决类似问题的
</code></pre><p>请记住上面的话</p>
<h3 id="0x01_USB相关资料">0x01 USB相关资料</h3><p>学习USB过程中，看了不少资料，在此列出来，希望能帮到各位</p>
<ol>
<li><a href="www.usb.org">USB2.0协议</a><br>在学习USB前，请先翻翻USB原版协议，不要求能看懂，先了解框架，有个大致印象就好。回头再深入研究细节</li>
<li><a href="http://www.beyondlogic.org/usbnutshell/usb1.shtml" target="_blank" rel="external">USB in a NutShel</a><br>用非常通俗易懂的语言来教你怎么看USB协议，描述了整个架构，非常清晰</li>
<li><a href="http://bbs.ednchina.com/BLOG_computer00_27799.HTM" target="_blank" rel="external">电脑圈圈</a><br>我主要看上面两个资料，电脑圈圈的，据说不错，在此推荐一下</li>
<li>STM32 手册 USB章节<br>详细的读几遍</li>
<li>ST USB Device代码<br> 个人建议直接看源码，也不多，架构挺简单；不要被网上一大堆分析源码的文章迷惑，，，那是他们的事后总结，如果你希望通过看那些文章入门，注定是半吊子工程师，洗洗睡吧</li>
</ol>
<p>暂时就列这么多，学USB基础架构足够了，明天聊USB协议框架</p>
<p>PS：还记得那句话么<br><strong>有时候，遇到解决不了，想不通的计算机问题，不妨观察一下现实社会，人是怎么解决类似问题的</strong></p>
<p>USB就是为了简化设备接口而设计的，学架构时，搞不懂时，就多想想公司架构是怎么设计的，国家部门是怎么设计的</p>
<p>2015-12-7</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信订阅号/">微信订阅号</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-USB-update-firmware-for-stm32" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/03/USB-update-firmware-for-stm32/" class="article-date">
  	<time datetime="2015-12-03T12:43:47.000Z" itemprop="datePublished">2015-12-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/03/USB-update-firmware-for-stm32/">USB 固件升级</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近做了一个USB工具，像U盘拷贝一样，升级STM32固件</p>
<p>手册链接如下所示</p>
<p>有朋友说amobbs下载不了文件，这里传一份吧</p>
<p><a href="https://github.com/cedar-renjun/cedar-renjun.github.io/tree/master/assets/2015/12/3/USB_MSD_Bootloader.hex.zip" target="_blank" rel="external">https://github.com/cedar-renjun/cedar-renjun.github.io/tree/master/assets/2015/12/3/USB_MSD_Bootloader.hex.zip</a><br><a href="https://github.com/cedar-renjun/cedar-renjun.github.io/tree/master/assets/2015/12/3/USB_MSD_Updater_User_Manual.pdf" target="_blank" rel="external">https://github.com/cedar-renjun/cedar-renjun.github.io/tree/master/assets/2015/12/3/USB_MSD_Updater_User_Manual.pdf</a><br><a href="https://github.com/cedar-renjun/cedar-renjun.github.io/tree/master/assets/2015/12/3/USB_MSD_Bootloader_Usage.pdf" target="_blank" rel="external">https://github.com/cedar-renjun/cedar-renjun.github.io/tree/master/assets/2015/12/3/USB_MSD_Bootloader_Usage.pdf</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-usb-re-enum" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/28/usb-re-enum/" class="article-date">
  	<time datetime="2015-11-28T11:41:57.000Z" itemprop="datePublished">2015-11-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/28/usb-re-enum/">USB 重枚举</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基本思路：拉低DP信号，保持一定时间，然后释放</p>
<p>在STM32上的用法为：</p>
<ol>
<li>关闭USB电源</li>
<li>配置DP脚，拉低</li>
<li>延时一段时间，释放DP脚</li>
<li>重新配置USB</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-usb-suspended" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/25/usb-suspended/" class="article-date">
  	<time datetime="2015-11-25T14:35:29.000Z" itemprop="datePublished">2015-11-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/25/usb-suspended/">usb suspended</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Q: USB设备进入暂停模式的条件是？<br>A: 总线上，3ms空闲状态，即让设备进入暂停模式</p>
<p>Q: USB设备如何退出暂停模式？<br>A: USB任意的总线活动，都会让USB设备退出休眠状态，但一般情况来说，虽然USB<br>Device会产生唤醒中断，但软件层面硬件检查DP，DM的电平值，从而确定是干扰还是HOST唤醒事件</p>
<p>Q: 退出暂停模式后，需要重新进行配置么？<br>A: 不需要，因为在暂停时，已经保存了内部状态，比如端点信息和地址信息；在恢复时，只需要恢复时钟和对应外设功能就好</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-usb-recognition-produce" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/22/usb-recognition-produce/" class="article-date">
  	<time datetime="2015-11-21T16:33:55.000Z" itemprop="datePublished">2015-11-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/22/usb-recognition-produce/">USB 插入动作</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li>USB 设备插入</li>
<li>HUB 通过检测DP/DM电平变化，识别出USB插入动作</li>
<li>HUB 等待100ms左右，等待设备供电稳定和初始化完成</li>
<li>HUB 请求 Device复位，Device进入默认状态，此时最大可用电流为100ma</li>
<li>HUB 分配唯一地址给Device</li>
<li>HUB 发送设备请求命令，获取Device属性和功能</li>
<li>HUB 根据实际情况，返回配置信息，配置Device，Device完成配置</li>
<li>Device处于可用状态，开始正常传输数据</li>
<li>Device设备拔出，HUB回收地址，更新逻辑树结构，通知HOST</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-why-use-required-device-reset-when-plugin" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/22/why-use-required-device-reset-when-plugin/" class="article-date">
  	<time datetime="2015-11-21T16:07:10.000Z" itemprop="datePublished">2015-11-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/22/why-use-required-device-reset-when-plugin/">为什么USB协议中，检测到设备插入时，要求复位</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>因为USB属于可插拔设备，这种特性就要求设备不具备记忆的特性，也就是有限状态机特性。<br>为了确保状态可控，所以就要求设备复位，从而</p>
<ol>
<li>确保HUB检测到设备拔出时，能及时回收地址</li>
<li>确保USB设备在插入HUB端口时，能进入一个确定的状态，消除旧环境的影响</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/USB/">USB</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 Do one thing and do it well
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>